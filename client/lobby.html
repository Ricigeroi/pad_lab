<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Sudoku Lobby Game</title>
    <link rel="stylesheet" href="lobby.css">
    <style>
        /* Ваши стили CSS */

        body {
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
            margin: 0;
            padding: 0;
        }

        #container {
            width: 80%;
            margin: auto;
            overflow: hidden;
        }

        h1, h2 {
            text-align: center;
        }

        #create-lobby, #lobbies-list, #game-section, #game-history {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        #board {
            display: grid;
            grid-template-columns: repeat(9, 40px);
            grid-template-rows: repeat(9, 40px);
            gap: 2px;
            margin: 20px auto;
            width: fit-content;
        }

        .cell {
            width: 40px;
            height: 40px;
            border: 1px solid #ccc;
            text-align: center;
            line-height: 40px;
            font-size: 18px;
        }

        .editable {
            background-color: #e6ffe6;
            cursor: pointer;
        }

        .selected {
            border: 2px solid #000;
        }

        #messages {
            max-height: 200px;
            overflow-y: auto;
            background-color: #f9f9f9;
            padding: 10px;
            margin-bottom: 10px;
        }

        #send-message {
            display: flex;
            justify-content: space-between;
        }

        #send-message input {
            width: 80%;
            padding: 10px;
        }

        #send-message button {
            width: 18%;
            padding: 10px;
        }

        #notifications {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .notification {
            background-color: #f44336;
            color: white;
            padding: 15px;
            margin-bottom: 5px;
            border-radius: 3px;
            position: relative;
            min-width: 200px;
        }

        .notification.success {
            background-color: #4CAF50;
        }

        .close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

        #game-history-list li {
            margin-bottom: 10px;
        }

        #game-history-list button {
            margin-left: 10px;
        }

        /* Стили для модального окна */
        #chat-history-modal {
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        #chat-history-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            position: relative;
        }

        #close-chat-history {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        #close-chat-history:hover,
        #close-chat-history:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #chat-history-list {
            list-style-type: none;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        #chat-history-list li {
            padding: 5px 0;
            border-bottom: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Sudoku Lobby Game</h1>

        <!-- Создание Лобби -->
        <div id="create-lobby">
            <h2>Создать Лобби</h2>
            <input type="text" id="game-id" placeholder="Введите Game ID">
            <button id="create-lobby-button">Создать Лобби</button>
        </div>

        <!-- Список Лобби -->
        <div id="lobbies-list">
            <h2>Доступные Лобби</h2>
            <ul id="lobbies-ul">
                <!-- Лобби будут добавляться здесь -->
            </ul>
        </div>

        <!-- Игровой Раздел -->
        <div id="game-section" style="display: none;">
            <h2>Лобби: <span id="current-lobby-id"></span></h2>
            <div id="board">
                <!-- Ячейки доски будут добавляться здесь -->
            </div>
            <div id="messages"></div>
            <div id="send-message">
                <input type="text" id="message-input" placeholder="Введите сообщение">
                <button id="send-button">Отправить</button>
            </div>
            <button id="leave-button">Покинуть Лобби</button>
        </div>

        <!-- История Игр -->
        <div id="game-history">
            <h2>Ваша История Игр</h2>
            <ul id="game-history-list"></ul>
        </div>
    </div>

    <!-- Блок для отображения уведомлений -->
    <div id="notifications"></div>

    <!-- Модальное окно для истории чата -->
    <div id="chat-history-modal" style="display: none;">
        <div id="chat-history-content">
            <span id="close-chat-history">&times;</span>
            <h2>История чата игры</h2>
            <ul id="chat-history-list"></ul>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:5029'; // URL вашего API Gateway
        const LOBBY_SERVICE_URL = `${BASE_URL}`; // Если лобби-сервис доступен по корню или под /lobby_service

        let websocket = null;
        let currentLobbyId = null;
        let username = null; // Хранение реального имени пользователя
        let accessToken = localStorage.getItem('access_token'); // Получение токена из localStorage

        // Проверка наличия токена при загрузке страницы
        if (!accessToken) {
            // Если токен отсутствует, перенаправить на страницу входа
            window.location.href = 'login.html';
        } else {
            // Decode JWT to get the username
            const tokenParts = accessToken.split('.');
            if (tokenParts.length === 3) {
                const payload = JSON.parse(atob(tokenParts[1]));
                username = payload.sub;
                // Fetch game history
                fetchGameHistory();
            }
        }

        // Элементы DOM
        const createLobbyButton = document.getElementById('create-lobby-button');
        const gameIdInput = document.getElementById('game-id');
        const lobbiesUl = document.getElementById('lobbies-ul');
        const gameSection = document.getElementById('game-section');
        const currentLobbyIdSpan = document.getElementById('current-lobby-id');
        const boardDiv = document.getElementById('board');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const leaveButton = document.getElementById('leave-button');

        // Функция для перенаправления на страницу входа
        function redirectToLogin() {
            // Очистить токен из localStorage
            localStorage.removeItem('access_token');
            // Перенаправить пользователя на страницу входа
            window.location.href = 'login.html';
        }

        // Функция для отображения уведомлений
        function showNotification(message, type = 'error') {
            const notificationsDiv = document.getElementById('notifications');
            
            const notification = document.createElement('div');
            notification.classList.add('notification');
            if (type === 'error') {
                notification.style.backgroundColor = '#f44336'; // Красный для ошибок
            } else if (type === 'success') {
                notification.style.backgroundColor = '#4CAF50'; // Зеленый для успеха
            }

            // Добавить сообщение
            notification.textContent = message;

            // Добавить кнопку закрытия
            const closeBtn = document.createElement('span');
            closeBtn.classList.add('close-btn');
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => {
                notificationsDiv.removeChild(notification);
            };
            notification.appendChild(closeBtn);

            notificationsDiv.appendChild(notification);

            // Автоматически удалить уведомление через 5 секунд
            setTimeout(() => {
                if (notificationsDiv.contains(notification)) {
                    notificationsDiv.removeChild(notification);
                }
            }, 5000);
        }

        // Создание Лобби
        createLobbyButton.addEventListener('click', async () => {
            const gameId = gameIdInput.value.trim();
            if (!gameId) {
                showNotification('Пожалуйста, введите Game ID.', 'error');
                return;
            }

            try {
                const response = await fetch(`${LOBBY_SERVICE_URL}/lobbies`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ gameId })
                });

                if (response.status === 401) {
                    showNotification('Сессия истекла. Пожалуйста, войдите снова.', 'error');
                    redirectToLogin();
                    return;
                }

                if (!response.ok) {
                    const error = await response.json();
                    showNotification(`Ошибка: ${error.detail}`, 'error');
                    return;
                }

                const data = await response.json();
                showNotification(`Лобби создано! ID: ${data.lobbyId}`, 'success');
                fetchLobbies(); // Обновить список лобби
            } catch (error) {
                console.error('Ошибка при создании лобби:', error);
                showNotification('Произошла ошибка при создании лобби.', 'error');
            }
        });

        // Получение Списка Лобби
        async function fetchLobbies() {
            try {
                const response = await fetch(`${LOBBY_SERVICE_URL}/lobbies`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                if (response.status === 401) {
                    showNotification('Сессия истекла. Пожалуйста, войдите снова.', 'error');
                    redirectToLogin();
                    return;
                }
                if (!response.ok) {
                    const error = await response.json();
                    console.error(`Ошибка при получении лобби: ${error.detail}`);
                    showNotification(`Ошибка при получении лобби: ${error.detail}`, 'error');
                    return;
                }
                const lobbies = await response.json();
                renderLobbies(lobbies);
            } catch (error) {
                console.error('Ошибка при получении лобби:', error);
                showNotification('Произошла ошибка при получении лобби.', 'error');
            }
        }

        // Рендеринг Списка Лобби
        function renderLobbies(lobbies) {
            lobbiesUl.innerHTML = '';
            if (lobbies.length === 0) {
                lobbiesUl.innerHTML = '<li>Нет доступных лобби.</li>';
                return;
            }
            lobbies.forEach(lobby => {
                const li = document.createElement('li');
                li.textContent = `Лобби ID: ${lobby.lobbyId} | Игроков: ${lobby.players.length}/2`;
                const joinButton = document.createElement('button');
                joinButton.textContent = 'Присоединиться';
                joinButton.addEventListener('click', () => joinLobby(lobby.lobbyId));
                li.appendChild(joinButton);
                lobbiesUl.appendChild(li);
            });
        }

        // Присоединение к Лобби
        async function joinLobby(lobbyId) {
            if (!accessToken) {
                showNotification('Пожалуйста, войдите в систему перед присоединением к лобби.', 'error');
                return;
            }

            try {
                // Используем URL Gateway для WebSocket подключения
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                websocket = new WebSocket(`${wsProtocol}//localhost:5029/ws/lobby/${lobbyId}?token=${accessToken}`); // Используем адрес Gateway

                websocket.onopen = () => {
                    console.log('WebSocket соединение открыто');
                };

                websocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };

                websocket.onclose = (event) => {
                    console.log('WebSocket соединение закрыто');
                    if (event.code === 1008) { // Policy Violation
                        showNotification('Неверный токен. Пожалуйста, войдите снова.', 'error');
                        redirectToLogin();
                    } else if (currentLobbyId) {
                        showNotification('Соединение с сервером закрыто.', 'error');
                        resetGameSection();
                    }
                };

                websocket.onerror = (error) => {
                    console.error('WebSocket ошибка:', error);
                    showNotification('Произошла ошибка WebSocket.', 'error');
                };

                currentLobbyId = lobbyId;
                currentLobbyIdSpan.textContent = lobbyId;
                gameSection.style.display = 'block';
                fetchBoard(lobbyId);

            } catch (error) {
                console.error('Ошибка при подключении к WebSocket:', error);
                showNotification('Произошла ошибка при подключении к лобби.', 'error');
            }
        }

        // Обработка Сообщений от WebSocket
        function handleWebSocketMessage(data) {
            if (data.message) {
                addMessage(data.message);
                // Извлечение username из сообщения "username подключился к лобби."
                if (data.message.includes("подключился к лобби")) {
                    username = data.message.split(" подключился")[0];
                }
                if (data.message.includes('Game starts')) {
                    showNotification('Игра начинается!', 'success');
                }
                if (data.message.includes('покинул лобби')) {
                    showNotification('Другой игрок покинул лобби.', 'error');
                    resetGameSection();
                }
                if (data.message.includes('Game Over')) {
                    showNotification(data.message, 'success');
                    resetGameSection();
                }
                // Дополнительно: обработка сообщения о неверном токене, если сервер отправляет такое
                if (data.message.includes('Invalid token')) {
                    showNotification('Неверный токен. Пожалуйста, войдите снова.', 'error');
                    redirectToLogin();
                }
            }
            if (data.board) {
                updateBoard(data.board);
            }
            if (data.error) {
                addMessage(`Ошибка: ${data.error}`);
                showNotification(`Ошибка: ${data.error}`, 'error');
                // Если ошибка связана с токеном, можно добавить перенаправление
                if (data.error.toLowerCase().includes('invalid token')) {
                    redirectToLogin();
                }
            }
        }

        // Отправка Сообщений через WebSocket (чат)
        sendButton.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message && websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({ type: 'chat', player: username, message }));
                messageInput.value = '';
            }
        });

        // Покинание Лобби
        leaveButton.addEventListener('click', () => {
            if (websocket) {
                websocket.close();
            }
            resetGameSection();
        });

        // Сброс Игрового Раздела
        function resetGameSection() {
            gameSection.style.display = 'none';
            currentLobbyId = null;
            boardDiv.innerHTML = '';
            messagesDiv.innerHTML = '';
        }

        // Добавление Сообщений в Чат
        function addMessage(message) {
            const div = document.createElement('div');
            div.textContent = message;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Получение и Рендеринг Доски
        async function fetchBoard(lobbyId) {
            try {
                const response = await fetch(`${LOBBY_SERVICE_URL}/lobbies/${lobbyId}`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                if (response.status === 401) {
                    showNotification('Сессия истекла. Пожалуйста, войдите снова.', 'error');
                    redirectToLogin();
                    return;
                }
                if (!response.ok) {
                    const error = await response.json();
                    showNotification(`Ошибка: ${error.detail}`, 'error');
                    return;
                }
                const lobby = await response.json();
                updateBoard(lobby.board);
            } catch (error) {
                console.error('Ошибка при получении доски:', error);
                showNotification('Произошла ошибка при получении доски.', 'error');
            }
        }

        // Рендеринг Доски
        function updateBoard(board) {
            boardDiv.innerHTML = '';
            board.forEach((row, rowIndex) => {
                row.forEach((cell, colIndex) => {
                    const cellDiv = document.createElement('div');
                    cellDiv.classList.add('cell');
                    cellDiv.dataset.row = rowIndex;
                    cellDiv.dataset.col = colIndex;

                    if (cell !== 0) {
                        cellDiv.textContent = cell;
                        cellDiv.style.backgroundColor = '#d3d3d3';
                    } else {
                        cellDiv.classList.add('editable');
                        cellDiv.setAttribute('contenteditable', 'true');
                        cellDiv.addEventListener('focus', () => selectCell(cellDiv));
                        cellDiv.addEventListener('blur', () => sendMove(cellDiv));
                        cellDiv.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                cellDiv.blur();
                            }
                        });
                    }

                    boardDiv.appendChild(cellDiv);
                });
            });
        }

        // Выбор Ячейки
        function selectCell(cellDiv) {
            // Удалить выделение со всех ячеек
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('selected');
            });
            // Выделить текущую ячейку
            cellDiv.classList.add('selected');
        }

        // Отправка Хода на Сервер
        function sendMove(cellDiv) {
            const row = parseInt(cellDiv.dataset.row);
            const col = parseInt(cellDiv.dataset.col);
            const value = parseInt(cellDiv.textContent.trim());

            // Валидация ввода
            if (isNaN(value) || value < 1 || value > 9) {
                showNotification('Пожалуйста, введите число от 1 до 9.', 'error');
                cellDiv.textContent = '';
                return;
            }

            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                showNotification('WebSocket соединение не установлено.', 'error');
                return;
            }

            const move = {
                type: 'move',
                player: username,
                row: row,
                col: col,
                value: value
            };
            websocket.send(JSON.stringify(move));

        }

        // Функция для получения и отображения истории игр
        async function fetchGameHistory() {
            try {
                const response = await fetch(`${LOBBY_SERVICE_URL}/users/${username}/games`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                if (response.ok) {
                    const games = await response.json();
                    renderGameHistory(games);
                } else {
                    const error = await response.json();
                    showNotification(`Ошибка при получении истории игр: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Ошибка при получении истории игр:', error);
                showNotification('Произошла ошибка при получении истории игр.', 'error');
            }
        }

        // Функция для отображения истории игр
        function renderGameHistory(games) {
            const gameHistoryList = document.getElementById('game-history-list');
            gameHistoryList.innerHTML = '';
            games.forEach(game => {
                const li = document.createElement('li');
                li.textContent = `Game ID: ${game.game_id}, Started: ${new Date(game.start_time).toLocaleString()}, Winner: ${game.winner || 'n/a'}`;
                
                // Кнопка для просмотра истории чата
                const chatHistoryButton = document.createElement('button');
                chatHistoryButton.textContent = 'Просмотреть историю чата';
                chatHistoryButton.addEventListener('click', () => {
                    fetchGameChatHistory(game.id);
                });

                li.appendChild(chatHistoryButton);
                gameHistoryList.appendChild(li);
            });
        }

        // Функция для получения и отображения истории чата конкретной игры
        async function fetchGameChatHistory(gameId) {
            try {
                const response = await fetch(`${LOBBY_SERVICE_URL}/games/${gameId}/chat_history`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                if (response.ok) {
                    const messages = await response.json();
                    renderChatHistory(messages);
                } else {
                    const error = await response.json();
                    showNotification(`Ошибка при получении истории чата: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Ошибка при получении истории чата:', error);
                showNotification('Произошла ошибка при получении истории чата.', 'error');
            }
        }

        // Функция для отображения истории чата в модальном окне
        function renderChatHistory(messages) {
            const chatHistoryList = document.getElementById('chat-history-list');
            chatHistoryList.innerHTML = '';
            messages.forEach(message => {
                const li = document.createElement('li');
                li.textContent = `[${new Date(message.timestamp).toLocaleString()}] ${message.sender}: ${message.message}`;
                chatHistoryList.appendChild(li);
            });
            // Отображаем модальное окно
            document.getElementById('chat-history-modal').style.display = 'block';
        }

        // Закрытие модального окна
        document.getElementById('close-chat-history').onclick = function() {
            document.getElementById('chat-history-modal').style.display = 'none';
        }

        // Закрытие модального окна при клике вне его области
        window.onclick = function(event) {
            const modal = document.getElementById('chat-history-modal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Автоматическое обновление списка лобби каждые 5 секунд
        setInterval(fetchLobbies, 5000);

        // Первоначальная загрузка списка лобби
        fetchLobbies();
    </script>
</body>
</html>
