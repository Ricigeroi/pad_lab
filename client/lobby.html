<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>Sudoku Lobby Game</title>
    <link rel="stylesheet" href="lobby.css">
    <style>
        /* Основные стили */

        body {
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #container {
            width: 90%;
            max-width: 1200px;
            margin: auto;
            overflow: hidden;
            display: flex;
            flex: 1;
            flex-direction: row;
            padding: 20px 0;
            overflow-y: auto;
        }

        h1,
        h2 {
            text-align: center;
        }

        /* Левая панель: Создание и список лобби */
        .left-panel {
            width: 25%;
            padding: 20px;
            box-sizing: border-box;
        }

        #create-lobby,
        #lobbies-list,
        #game-history {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Правая панель: Игровой раздел и чат */
        .right-panel {
            width: 75%;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        #game-section {
            flex: 1;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Стилизация доски Sudoku */
        #board {
            display: grid;
            grid-template-columns: repeat(9, 40px);
            grid-template-rows: repeat(9, 40px);
            gap: 2px;
            margin: 20px 0;
            position: relative;
        }

        .cell {
            width: 40px;
            height: 40px;
            border: 1px solid #ccc;
            text-align: center;
            line-height: 40px;
            font-size: 18px;
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        /* Толстые границы для блоков 3x3 */
        #board .cell {
            border: 1px solid #ccc;
            z-index: 100;
        }

        #board .cell:nth-child(3n+1) {
            border-left: 2px solid #000;
            /* Левые границы каждого третьего блока */
        }

        #board .cell:nth-child(3n) {
            border-right: 2px solid #000;
            /* Правые границы каждого третьего блока */
        }

        #board .cell:nth-of-type(n+19):nth-of-type(-n+27),
        #board .cell:nth-of-type(n+46):nth-of-type(-n+54),
        #board .cell:nth-of-type(n+73):nth-of-type(-n+81) {
            border-bottom: 2px solid #000;
            /* Нижние границы для третьих рядов */
        }

        #board .cell:nth-of-type(-n+9),
        #board .cell:nth-of-type(n+28):nth-of-type(-n+36),
        #board .cell:nth-of-type(n+55):nth-of-type(-n+63) {
            border-top: 2px solid #000;
            /* Верхние границы для первых рядов */
        }


        .pre-filled {
            background-color: #d3d3d3;
            cursor: default;
        }

        /* Цвета для игроков */
        .player-red {
            background-color: rgba(255, 0, 0, 0.5);
            /* Красный */
            color: #fff;
        }

        .player-blue {
            background-color: rgba(25, 0, 255, 0.5);
            /* Синий */
            color: #fff;
        }

        /* Дополнительные цвета (при необходимости) */
        .player-green {
            background-color: rgba(0, 255, 0, 0.5);
            color: #fff;
        }

        .player-yellow {
            background-color: rgba(255, 255, 0, 0.5);
            color: #000;
        }

        /* Кнопка стирания должна занимать всю клетку */
        .erase-button {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: transparent;
            border: none;
            font-size: 0;
            /* Скрыть текст */
            cursor: pointer;
            z-index: 1;
            /* Поставить её выше текста */
        }

        .erase-button:hover {
            background-color: rgba(255, 0, 0, 0.2);
            /* Опционально: добавить красный оттенок при наведении */
        }

        /* Удаляем border у пустых клеток */
        .cell.editable {
            border: 1px solid #ccc;
        }

        /* Стилизация чата */
        #chat {
            flex: none;
            /* Отключаем растягивание чата */
            width: 100%;
            /* Ширина 100%, чтобы занять доступное пространство */
            height: 100px;
            /* Фиксированная высота */
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            /* Добавляем прокрутку по вертикали */
            background-color: #fafafa;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .chat-message {
            margin-bottom: 5px;
        }

        .chat-message .sender {
            font-weight: bold;
            margin-right: 5px;
        }

        #chat-input {
            display: flex;
        }

        #chat-input input {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        #chat-input button {
            padding: 10px;
            font-size: 16px;
            margin-left: 5px;
            border: none;
            background-color: #4CAF50;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }

        #chat-input button:hover {
            background-color: #45a049;
        }

        /* Стили для уведомлений */
        #notifications {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .notification {
            background-color: #f44336;
            color: white;
            padding: 15px;
            margin-bottom: 5px;
            border-radius: 3px;
            position: relative;
            min-width: 200px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .notification.success {
            background-color: #4CAF50;
        }

        .close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

        /* Модальное окно для истории чата */
        #chat-history-modal {
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            display: none;
        }

        #chat-history-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            position: relative;
            border-radius: 5px;
        }

        #close-chat-history {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        #close-chat-history:hover,
        #close-chat-history:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #chat-history-list {
            list-style-type: none;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        #chat-history-list li {
            padding: 5px 0;
            border-bottom: 1px solid #ccc;
        }

        /* Стилизация списка игроков и счётов */
        #players-list,
        #players-list li {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        /* Сделать список счётов горизонтальным и увеличить жирность шрифта */
        #scores-list {
            display: flex;
            flex-direction: row;
            justify-content: flex-start;
            align-items: center;
            padding: 0;
            /* Убрать отступы списка */
            margin: 0;
            /* Убрать внешние отступы списка */
        }

        #scores-list li {
            margin-right: 20px;
            /* Отступ между элементами списка */
            font-weight: bold;
            /* Увеличенная жирность шрифта */
            display: flex;
            align-items: center;
        }

        /* Убедитесь, что цветовые индикаторы не влияют на выравнивание текста */
        .player-color {
            margin-right: 8px;
            /* Отступ между индикатором и именем игрока */
        }

        .player-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
        }

        /* История игр */
        #game-history-list li {
            margin-bottom: 10px;
        }

        #game-history-list button {
            margin-left: 10px;
            padding: 5px 10px;
            border: none;
            background-color: #2196F3;
            color: white;
            border-radius: 3px;
            cursor: pointer;
        }

        #game-history-list button:hover {
            background-color: #0b7dda;
        }

        /* Кнопка покидания лобби */
        #leave-button {
            padding: 10px 20px;
            border: none;
            background-color: #f44336;
            color: white;
            border-radius: 3px;
            cursor: pointer;
            align-self: flex-end;
        }

        #leave-button:hover {
            background-color: #da190b;
        }

        /* Медиа-запросы для адаптивности */
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }

            .left-panel,
            .right-panel {
                width: 100%;
            }

            #chat-history-content {
                width: 90%;
            }
        }
    </style>
</head>

<body>
    <h1>Sudoku Lobby Game</h1>

    <div id="container">
        <!-- Левая панель: Создание и список лобби -->
        <div class="left-panel">
            <!-- Создание Лобби -->
            <div id="create-lobby">
                <h2>Создать Лобби</h2>
                <input type="text" id="game-id" placeholder="Введите Game ID" />
                <button id="create-lobby-button">Создать Лобби</button>
            </div>

            <!-- Список Лобби -->
            <div id="lobbies-list">
                <h2>Доступные Лобби</h2>
                <ul id="lobbies-ul">
                    <!-- Лобби будут добавляться здесь -->
                </ul>
            </div>
        </div>

        <!-- Правая панель: Игровой раздел и чат -->
        <div class="right-panel">
            <!-- Игровой Раздел -->
            <div id="game-section" style="display: none;">
                <h2>Лобби: <span id="current-lobby-id"></span></h2>
                <div id="scores">
                    <h3>Счётчики</h3>
                    <ul id="scores-list">
                        <!-- Счётчики будут обновляться здесь -->
                    </ul>
                </div>
                <div id="board">
                    <!-- Ячейки доски будут добавляться здесь -->
                </div>
                <div id="chat">
                    <!-- Сообщения чата будут здесь -->
                </div>
                <div id="chat-input">
                    <input type="text" id="message-input" placeholder="Введите сообщение" />
                    <button id="send-button">Отправить</button>
                </div>
                <button id="leave-button">Покинуть Лобби</button>
            </div>

            <!-- История Игр -->
            <div id="game-history">
                <h2>Ваша История Игр</h2>
                <ul id="game-history-list">
                    <!-- История игр будет добавляться здесь -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Блок для отображения уведомлений -->
    <div id="notifications"></div>

    <!-- Модальное окно для истории чата -->
    <div id="chat-history-modal">
        <div id="chat-history-content">
            <span id="close-chat-history">&times;</span>
            <h2>История чата игры</h2>
            <ul id="chat-history-list"></ul>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:5029'; // URL вашего API Gateway
        const LOBBY_SERVICE_URL = BASE_URL; // Если лобби-сервис доступен по корню или под /lobby_service

        let websocket = null;
        let currentLobbyId = null;
        let username = null; // Хранение реального имени пользователя
        let accessToken = localStorage.getItem('access_token'); // Получение токена из localStorage

        // Словарь для сопоставления имен пользователей с CSS-классами
        let playerClasses = {}; // Пример: { "player1": "player-red", "player2": "player-blue" }

        // Проверка наличия токена при загрузке страницы
        if (!accessToken) {
            // Если токен отсутствует, перенаправить на страницу входа
            window.location.href = 'login.html';
        } else {
            // Decode JWT to get the username
            const tokenParts = accessToken.split('.');
            if (tokenParts.length === 3) {
                const payload = JSON.parse(atob(tokenParts[1]));
                username = payload.sub;
                // Fetch game history
                fetchGameHistory();
            }
        }

        // Элементы DOM
        const createLobbyButton = document.getElementById('create-lobby-button');
        const gameIdInput = document.getElementById('game-id');
        const lobbiesUl = document.getElementById('lobbies-ul');
        const gameHistoryList = document.getElementById('game-history-list');
        const gameSection = document.getElementById('game-section');
        const currentLobbyIdSpan = document.getElementById('current-lobby-id');
        const boardDiv = document.getElementById('board');
        const chatDiv = document.getElementById('chat');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const leaveButton = document.getElementById('leave-button');
        const scoresList = document.getElementById('scores-list');

        // Функция для перенаправления на страницу входа
        function redirectToLogin() {
            // Очистить токен из localStorage
            localStorage.removeItem('access_token');
            // Перенаправить пользователя на страницу входа
            window.location.href = 'login.html';
        }

        // Функция для отображения уведомлений
        function showNotification(message, type = 'error') {
            const notificationsDiv = document.getElementById('notifications');

            const notification = document.createElement('div');
            notification.classList.add('notification');
            if (type === 'success') {
                notification.classList.add('success');
            }

            // Добавить сообщение
            notification.textContent = message;

            // Добавить кнопку закрытия
            const closeBtn = document.createElement('span');
            closeBtn.classList.add('close-btn');
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = () => {
                notificationsDiv.removeChild(notification);
            };
            notification.appendChild(closeBtn);

            notificationsDiv.appendChild(notification);

            // Автоматически удалить уведомление через 5 секунд
            setTimeout(() => {
                if (notificationsDiv.contains(notification)) {
                    notificationsDiv.removeChild(notification);
                }
            }, 5000);
        }

        // Создание Лобби
        createLobbyButton.addEventListener('click', async () => {
            const gameId = gameIdInput.value.trim();
            if (!gameId) {
                showNotification('Пожалуйста, введите Game ID.', 'error');
                return;
            }

            try {
                const response = await fetch(`${LOBBY_SERVICE_URL}/lobbies`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({ gameId })
                });

                if (response.status === 401) {
                    showNotification('Сессия истекла. Пожалуйста, войдите снова.', 'error');
                    redirectToLogin();
                    return;
                }

                if (!response.ok) {
                    const error = await response.json();
                    showNotification(`Ошибка: ${error.detail}`, 'error');
                    return;
                }

                const data = await response.json();
                showNotification(`Лобби создано! ID: ${data.lobbyId}`, 'success');
                fetchLobbies(); // Обновить список лобби
            } catch (error) {
                console.error('Ошибка при создании лобби:', error);
                showNotification('Произошла ошибка при создании лобби.', 'error');
            }
        });

        // Получение Списка Лобби
        async function fetchLobbies() {
            try {
                const response = await fetch(`${LOBBY_SERVICE_URL}/lobbies`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                if (response.status === 401) {
                    showNotification('Сессия истекла. Пожалуйста, войдите снова.', 'error');
                    redirectToLogin();
                    return;
                }
                if (!response.ok) {
                    const error = await response.json();
                    console.error(`Ошибка при получении лобби: ${error.detail}`);
                    showNotification(`Ошибка при получении лобби: ${error.detail}`, 'error');
                    return;
                }
                const lobbies = await response.json();
                renderLobbies(lobbies);
            } catch (error) {
                console.error('Ошибка при получении лобби:', error);
                showNotification('Произошла ошибка при получении лобби.', 'error');
            }
        }

        // Рендеринг Списка Лобби
        function renderLobbies(lobbies) {
            lobbiesUl.innerHTML = '';
            if (lobbies.length === 0) {
                lobbiesUl.innerHTML = '<li>Нет доступных лобби.</li>';
                return;
            }
            lobbies.forEach(lobby => {
                const li = document.createElement('li');
                li.textContent = `Лобби ID: ${lobby.lobbyId} | Игроков: ${lobby.players.length}/2`;
                const joinButton = document.createElement('button');
                joinButton.textContent = 'Присоединиться';
                joinButton.style.marginLeft = '10px';
                joinButton.style.padding = '5px 10px';
                joinButton.style.border = 'none';
                joinButton.style.backgroundColor = '#2196F3';
                joinButton.style.color = '#fff';
                joinButton.style.borderRadius = '3px';
                joinButton.style.cursor = 'pointer';
                joinButton.addEventListener('click', () => joinLobby(lobby.lobbyId));
                joinButton.onmouseover = () => { joinButton.style.backgroundColor = '#0b7dda'; };
                joinButton.onmouseout = () => { joinButton.style.backgroundColor = '#2196F3'; };
                li.appendChild(joinButton);
                lobbiesUl.appendChild(li);
            });
        }

        // Присоединение к Лобби
        async function joinLobby(lobbyId) {
            if (!accessToken) {
                showNotification('Пожалуйста, войдите в систему перед присоединением к лобби.', 'error');
                return;
            }

            try {
                // Используем URL Gateway для WebSocket подключения
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                websocket = new WebSocket(`${wsProtocol}//localhost:5029/ws/lobby/${lobbyId}?token=${accessToken}`); // Используем адрес Gateway

                websocket.onopen = () => {
                    console.log('WebSocket соединение открыто');
                };

                websocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };

                websocket.onclose = (event) => {
                    console.log('WebSocket соединение закрыто');
                    if (event.code === 1008) { // Policy Violation
                        showNotification('Неверный токен. Пожалуйста, войдите снова.', 'error');
                        redirectToLogin();
                    } else if (currentLobbyId) {
                        showNotification('Соединение с сервером закрыто.', 'error');
                        resetGameSection();
                    }
                };

                websocket.onerror = (error) => {
                    console.error('WebSocket ошибка:', error);
                    showNotification('Произошла ошибка WebSocket.', 'error');
                };

                currentLobbyId = lobbyId;
                currentLobbyIdSpan.textContent = lobbyId;
                gameSection.style.display = 'block';

                await fetchLobbyDetails(lobbyId); // Сначала получаем детали лобби и обновляем playerClasses
                await fetchBoard(lobbyId); // Затем обновляем доску

            } catch (error) {
                console.error('Ошибка при подключении к WebSocket:', error);
                showNotification('Произошла ошибка при подключении к лобби.', 'error');
            }
        }

        /**
         * Обрабатывает входящие сообщения от WebSocket.
         * @param {Object} data - Данные сообщения от сервера.
         */
        function handleWebSocketMessage(data) {
            try {
                switch (data.type) {
                    case "chat":
                        // Сообщение от игрока
                        addChatMessage(data.player, data.message);
                        break;

                    case "system":
                        // Системное сообщение
                        if (data.player && data.color) {
                            // Обновляем карту цветов игроков
                            playerClasses[data.player] = `player-${data.color}`;
                            // Обновляем отображение доски и счётов, чтобы применить новые классы
                            updateBoardIfVisible();
                            updateScoresIfVisible();
                        }
                        addChatMessage('Система', data.message);
                        break;

                    case "move":
                        // Ход игрока
                        addChatMessage('Система', data.message);
                        if (data.board) updateBoard(data.board);
                        if (data.scores) updateScores(data.scores);
                        break;

                    case "erase":
                        // Удаление клетки игроком
                        addChatMessage('Система', data.message);
                        if (data.board) updateBoard(data.board);
                        if (data.scores) updateScores(data.scores);
                        break;

                    case "game_over":
                        // Окончание игры
                        addChatMessage('Система', data.message);
                        if (data.board) updateBoard(data.board);
                        if (data.scores) updateScores(data.scores);
                        if (data.winner) {
                            showNotification(`Победитель: ${data.winner}`, 'success');
                            resetGameSection();
                        }
                        break;

                    case "error":
                        // Ошибки
                        console.error('Ошибка из WebSocket:', data.message);
                        showNotification(data.error, 'error');
                        break;

                    default:
                        console.warn('Неизвестный тип сообщения:', data.type);
                }

            } catch (error) {
                console.error('Ошибка при обработке сообщения WebSocket:', error, 'Данные:', data);
                showNotification('Произошла ошибка при обработке полученного сообщения.', 'error');
            }
        }

        // Отправка Сообщений через WebSocket (чат)
        sendButton.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message && websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({ type: 'chat', player: username, message }));
                messageInput.value = ''; // Очищаем поле ввода после отправки
            }
        });

        // Отправка сообщения по нажатию Enter
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendButton.click();
            }
        });

        // Покинание Лобби
        leaveButton.addEventListener('click', () => {
            if (websocket) {
                websocket.close();
            }
            resetGameSection();
        });

        // Сброс Игрового Раздела
        function resetGameSection() {
            gameSection.style.display = 'none';
            currentLobbyId = null;
            boardDiv.innerHTML = '';
            chatDiv.innerHTML = '';
            scoresList.innerHTML = '';
            playerClasses = {};
        }

        // Добавление Сообщений в Чат
        function addChatMessage(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            const senderSpan = document.createElement('span');
            senderSpan.classList.add('sender');
            senderSpan.textContent = `${sender}:`;
            const messageSpan = document.createElement('span');
            messageSpan.textContent = ` ${message}`;
            messageDiv.appendChild(senderSpan);
            messageDiv.appendChild(messageSpan);
            chatDiv.appendChild(messageDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight; // Прокрутить вниз
        }

        // Обновление очков
        // Обновление очков
        function updateScores(scores) {
            scoresList.innerHTML = ''; // Очистить список
            for (const [player, score] of Object.entries(scores)) {
                const li = document.createElement('li');

                // Создаем индикатор цвета
                const colorIndicator = document.createElement('span');
                colorIndicator.classList.add('player-color');
                const playerClass = playerClasses[player];
                if (playerClass) {
                    colorIndicator.classList.add(playerClass);
                }
                li.appendChild(colorIndicator);

                // Добавляем имя игрока в его цвете и счёт
                const playerNameSpan = document.createElement('span');
                playerNameSpan.classList.add();
                playerNameSpan.textContent = player;
                li.appendChild(playerNameSpan);

                // Добавляем счёт после имени
                const scoreText = document.createTextNode(`: ${score}`);
                li.appendChild(scoreText);

                scoresList.appendChild(li);
            }
        }


        // Получение и Рендеринг Доски
        async function fetchBoard(lobbyId) {
            try {
                const response = await fetch(`${LOBBY_SERVICE_URL}/lobbies/${lobbyId}`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                if (response.status === 401) {
                    showNotification('Сессия истекла. Пожалуйста, войдите снова.', 'error');
                    redirectToLogin();
                    return;
                }
                if (!response.ok) {
                    const error = await response.json();
                    showNotification(`Ошибка: ${error.detail}`, 'error');
                    return;
                }
                const lobby = await response.json();
                updateBoard(lobby.board);
                updateScores(lobby.scores);
                // Обновляем карту цветов игроков
                lobby.players.forEach(player => {
                    playerClasses[player.name] = `player-${player.color}`;
                });
            } catch (error) {
                console.error('Ошибка при получении доски:', error);
                showNotification('Произошла ошибка при получении доски.', 'error');
            }
        }

        // Рендеринг Доски
        function updateBoard(board) {
            console.log('Player Classes:', playerClasses);

            boardDiv.innerHTML = '';
            board.forEach((row, rowIndex) => {
                row.forEach((cell, colIndex) => {
                    const cellDiv = document.createElement('div');
                    cellDiv.classList.add('cell');
                    cellDiv.dataset.row = rowIndex;
                    cellDiv.dataset.col = colIndex;

                    if (cell !== 0 && typeof cell !== 'object') {
                        cellDiv.textContent = cell;
                        cellDiv.classList.add('pre-filled');
                    } else if (cell !== 0 && typeof cell === 'object') {
                        cellDiv.textContent = cell.value;
                        const owner = cell.owner;
                        if (owner) {
                            const playerClass = getPlayerClass(owner);
                            if (playerClass) {
                                cellDiv.classList.add(playerClass);
                            }
                        }
                        // Добавляем кнопку для стирания
                        const eraseButton = document.createElement('button');
                        eraseButton.classList.add('erase-button');
                        eraseButton.innerHTML = '&times;';
                        eraseButton.title = 'Стереть клетку';
                        eraseButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            eraseCell(rowIndex, colIndex);
                        });
                        cellDiv.appendChild(eraseButton);
                    } else {
                        cellDiv.classList.add('editable');
                        cellDiv.addEventListener('click', () => {
                            if (!cellDiv.classList.contains('pre-filled') && !cellDiv.classList.contains('editing')) {
                                cellDiv.classList.add('editing');
                                const input = document.createElement('input');
                                input.type = 'text';
                                input.style.width = '100%';
                                input.style.height = '100%';
                                input.style.textAlign = 'center';
                                input.style.fontSize = '18px';
                                input.style.border = 'none';
                                input.style.outline = 'none';
                                input.maxLength = 1;

                                // Заменяем содержимое клетки на поле ввода
                                cellDiv.textContent = '';
                                cellDiv.appendChild(input);
                                input.focus();

                                input.addEventListener('blur', () => {
                                    const value = input.value.trim();
                                    if (value !== '') {
                                        const num = parseInt(value);
                                        if (num >= 1 && num <= 9) {
                                            sendMove(rowIndex, colIndex, num);
                                        } else {
                                            showNotification('Пожалуйста, введите число от 1 до 9.', 'error');
                                        }
                                    }
                                    cellDiv.removeChild(input);
                                    cellDiv.classList.remove('editing');
                                });

                                input.addEventListener('keydown', (e) => {
                                    if (e.key === 'Enter') {
                                        input.blur();
                                    }
                                });
                            }
                        });
                    }

                    boardDiv.appendChild(cellDiv);
                });
            });
        }

        // Получение класса игрока по имени
        function getPlayerClass(playerName) {
            return playerClasses[playerName] || null;
        }

        // Функция для отправки хода
        function sendMove(row, col, value) {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                showNotification('WebSocket соединение не установлено.', 'error');
                return;
            }

            const move = {
                type: 'move',
                player: username,
                row: row,
                col: col,
                value: value
            };
            websocket.send(JSON.stringify(move));
        }

        // Функция для стирания клетки
        function eraseCell(row, col) {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                showNotification('WebSocket соединение не установлено.', 'error');
                return;
            }

            const erase = {
                type: 'erase',
                player: username,
                row: row,
                col: col
            };
            websocket.send(JSON.stringify(erase));
        }

        // Функция для получения и отображения истории игр
        async function fetchGameHistory() {
            try {
                const response = await fetch(`${LOBBY_SERVICE_URL}/users/${username}/games`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                if (response.ok) {
                    const games = await response.json();
                    renderGameHistory(games);
                } else {
                    const error = await response.json();
                    showNotification(`Ошибка при получении истории игр: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Ошибка при получении истории игр:', error);
                showNotification('Произошла ошибка при получении истории игр.', 'error');
            }
        }

        // Функция для отображения истории игр
        function renderGameHistory(games) {
            gameHistoryList.innerHTML = '';
            if (games.length === 0) {
                gameHistoryList.innerHTML = '<li>Нет истории игр.</li>';
                return;
            }

            // Реверсируем массив игр
            const reversedGames = games.reverse();

            reversedGames.forEach(game => {
                const li = document.createElement('li');
                li.textContent = `Game ID: ${game.game_id}, Начата: ${new Date(game.start_time).toLocaleString()}, Победитель: ${game.winner || 'n/a'}`;

                // Кнопка для просмотра истории чата
                const chatHistoryButton = document.createElement('button');
                chatHistoryButton.textContent = 'Просмотреть историю чата';
                chatHistoryButton.addEventListener('click', () => {
                    fetchGameChatHistory(game.id);
                });

                li.appendChild(chatHistoryButton);
                gameHistoryList.appendChild(li);
            });
        }

        // Функция для получения и отображения истории чата конкретной игры
        async function fetchGameChatHistory(gameId) {
            try {
                const response = await fetch(`${LOBBY_SERVICE_URL}/games/${gameId}/chat_history`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                if (response.ok) {
                    const messages = await response.json();
                    renderChatHistory(messages);
                } else {
                    const error = await response.json();
                    showNotification(`Ошибка при получении истории чата: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('Ошибка при получении истории чата:', error);
                showNotification('Произошла ошибка при получении истории чата.', 'error');
            }
        }

        // Функция для отображения истории чата в модальном окне
        function renderChatHistory(messages) {
            const chatHistoryList = document.getElementById('chat-history-list');
            chatHistoryList.innerHTML = '';
            messages.forEach(message => {
                const li = document.createElement('li');
                li.textContent = `[${new Date(message.timestamp).toLocaleString()}] ${message.sender}: ${message.message}`;
                chatHistoryList.appendChild(li);
            });
            // Отображаем модальное окно
            document.getElementById('chat-history-modal').style.display = 'block';
        }

        // Закрытие модального окна
        document.getElementById('close-chat-history').onclick = function () {
            document.getElementById('chat-history-modal').style.display = 'none';
        }

        // Закрытие модального окна при клике вне его области
        window.onclick = function (event) {
            const modal = document.getElementById('chat-history-modal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Автоматическое обновление списка лобби каждые 5 секунд
        setInterval(fetchLobbies, 5000);

        // Первоначальная загрузка списка лобби и истории игр
        fetchLobbies();
        fetchGameHistory();

        // Функция для обновления списка лобби
        // (Удалено дублирование функции)

        // Получение Деталей Лобби После Присоединения
        async function fetchLobbyDetails(lobbyId) {
            try {
                const response = await fetch(`${LOBBY_SERVICE_URL}/lobbies/${lobbyId}`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                if (!response.ok) {
                    showNotification('Не удалось получить детали лобби.', 'error');
                    return;
                }
                const lobbyDetails = await response.json();
                lobbyDetails.players.forEach(player => {
                    playerClasses[player.name] = `player-${player.color}`;
                });
                updateScores(lobbyDetails.scores);
                // Обновляем отображение доски и счётов после обновления playerClasses
                if (lobbyDetails.board) {
                    updateBoard(lobbyDetails.board);
                }
            } catch (error) {
                console.error('Ошибка при получении деталей лобби:', error);
                showNotification('Произошла ошибка при получении деталей лобби.', 'error');
            }
        }

        // Вспомогательные функции для обновления доски и счётов, если они видимы
        function updateBoardIfVisible() {
            if (currentLobbyId && boardDiv.innerHTML !== '') {
                // Можно повторно запросить доску или сохранить её состояние
                fetchBoard(currentLobbyId);
            }
        }

        function updateScoresIfVisible() {
            if (currentLobbyId && scoresList.innerHTML !== '') {
                // Можно повторно запросить счёты или сохранить их состояние
                fetchBoard(currentLobbyId); // fetchBoard обновляет и счёты
            }
        }
    </script>
</body>

</html>